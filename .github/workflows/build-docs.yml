name: Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'src/**'
      - 'mkdocs.yml'
      - 'pyproject.toml'
      - '.github/workflows/build-docs.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'src/**'
      - 'mkdocs.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rompy-swan
        uses: actions/checkout@v4

      - name: Checkout rompy-notebooks
        uses: actions/checkout@v4
        with:
          repository: rom-py/rompy-notebooks
          path: rompy-notebooks

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-docs-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-docs-

      - name: Cache MkDocs Material
        uses: actions/cache@v4
        with:
          path: ~/.cache/mkdocs
          key: mkdocs-material-${{ github.run_id }}
          restore-keys: |
            mkdocs-material-

      - name: Install package with docs dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"

      - name: Sync notebooks
        run: |
          mkdir -p docs/examples
          # Copy SWAN notebooks
          cp rompy-notebooks/notebooks/swan/*.ipynb docs/examples/ || true
          cp rompy-notebooks/notebooks/swan/*.yml docs/examples/ || true
          # Copy subdirectories (components, boundary, etc.)
          for subdir in rompy-notebooks/notebooks/swan/*/; do
            if [ -d "$subdir" ]; then
              dirname=$(basename "$subdir")
              mkdir -p "docs/examples/$dirname"
              cp "$subdir"*.ipynb "docs/examples/$dirname/" 2>/dev/null || true
              cp "$subdir"*.yml "docs/examples/$dirname/" 2>/dev/null || true
            fi
          done
          ls -la docs/examples/

      - name: Build documentation
        run: mkdocs build

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: mkdocs gh-deploy --force
